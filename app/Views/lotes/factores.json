{
  "UBICACION": [
    {
      "codigo": "FrenPrque",
      "nombre": "Frente al parque",
      "descripcion": "Lote con frente directo al parque."
    },
    {
      "codigo": "AvePrincipal",
      "nombre": "Frente a avenida principal",
      "descripcion": "Alta exposición comercial."
    },
    {
      "codigo": "AveSecundaria",
      "nombre": "Frente a avenida secundaria",
      "descripcion": "Tránsito medio."
    },
    {
      "codigo": "CercaAven",
      "nombre": "Cerca a avenida principal",
      "descripcion": "Ubicación estratégica cercana a vía importante."
    },
    {
      "codigo": "ZonaEscolar",
      "nombre": "Zona escolar",
      "descripcion": "Cerca a instituciones educativas."
    },
    {
      "codigo": "ZonaSalud",
      "nombre": "Zona salud",
      "descripcion": "Próximo a centros de salud."
    },
    {
      "codigo": "EjeComercial",
      "nombre": "Eje comercial",
      "descripcion": "Cerca a mercados, tiendas o malls."
    },
    {
      "codigo": "OrilMar",
      "nombre": "Cerca al mar",
      "descripcion": "Atractivo turístico y plusvalía."
    },
    {
      "codigo": "VisMontaña",
      "nombre": "Vista a montaña",
      "descripcion": "Vista natural valorada."
    },
    {
      "codigo": "VisAbierta",
      "nombre": "Vista abierta",
      "descripcion": "Vista panorámica sin obstrucciones."
    }
  ],

  "VISTA": [
    {
      "codigo": "SolPleno",
      "nombre": "Sol pleno",
      "descripcion": "Excelente orientación solar."
    },
    {
      "codigo": "VientBueno",
      "nombre": "Buena ventilación",
      "descripcion": "Flujo natural de aire."
    },
    {
      "codigo": "ZonaCalma",
      "nombre": "Zona calma",
      "descripcion": "Sin vientos fuertes."
    },
    {
      "codigo": "VisLibre",
      "nombre": "Vista libre",
      "descripcion": "Sin edificaciones al frente."
    },
    {
      "codigo": "VisCiudad",
      "nombre": "Vista ciudad",
      "descripcion": "Vista al skyline urbano."
    }
  ],

  "PLUSVALIA": [
    {
      "codigo": "ObrFutura",
      "nombre": "Obras futuras",
      "descripcion": "Cercanía a nuevas obras públicas."
    },
    {
      "codigo": "ZonaCrece",
      "nombre": "Zona en crecimiento",
      "descripcion": "Urbanización en expansión."
    },
    {
      "codigo": "ComerCerca",
      "nombre": "Comercio cerca",
      "descripcion": "Cerca de centros comerciales."
    },
    {
      "codigo": "ZonaFinanzas",
      "nombre": "Zona financiera",
      "descripcion": "Cerca de bancos y financieras."
    },
    {
      "codigo": "InstCerca",
      "nombre": "Instituciones cerca",
      "descripcion": "Cerca de municipalidades o comisarías."
    },
    {
      "codigo": "AvanceProy",
      "nombre": "Proyecto avanzado",
      "descripcion": "Etapa avanzada de construcción."
    }
  ],

  "RESTRICCION": [
    {
      "codigo": "RuidoAlto",
      "nombre": "Ruido alto",
      "descripcion": "Zona con alta contaminación sonora."
    },
    {
      "codigo": "ResiduCerca",
      "nombre": "Residuos cerca",
      "descripcion": "Cercanía a basurales o depósitos."
    },
    {
      "codigo": "RiesgAgua",
      "nombre": "Riesgo de inundación",
      "descripcion": "Zona baja expuesta a acumulación de agua."
    },
    {
      "codigo": "SuelDebil",
      "nombre": "Suelo débil",
      "descripcion": "Terreno inestable o de mala calidad."
    },
    {
      "codigo": "FajaSismica",
      "nombre": "Faja sísmica",
      "descripcion": "Área cercana a fallas geológicas."
    },
    {
      "codigo": "CriaderCerca",
      "nombre": "Criaderos cerca",
      "descripcion": "Cercanía a establos o granjas."
    },
    {
      "codigo": "IndusCerca",
      "nombre": "Industria cerca",
      "descripcion": "Zona industrial próxima."
    },
    {
      "codigo": "AntenaCerca",
      "nombre": "Antenas cerca",
      "descripcion": "Torres o antenas visibles."
    }
  ],

  "GLOBALES": [
    {
      "codigo": "CampGeneral",
      "nombre": "Campaña general",
      "descripcion": "Descuento global del proyecto."
    },
    {
      "codigo": "PromoPago",
      "nombre": "Promoción de pago",
      "descripcion": "Facilidades de financiamiento."
    },
    {
      "codigo": "PrecLanzam",
      "nombre": "Precio lanzamiento",
      "descripcion": "Precio promocional inicial."
    },
    {
      "codigo": "DescTemp",
      "nombre": "Descuento temporada",
      "descripcion": "Descuento por temporada o fechas especiales."
    }
  ],

  "ETAPA_PROYECTO": [
    {
      "codigo": "EtapaPlanos",
      "nombre": "En planos",
      "descripcion": "Etapa inicial del proyecto."
    },
    {
      "codigo": "InicioObra",
      "nombre": "Inicio de obra",
      "descripcion": "Construcción temprana."
    },
    {
      "codigo": "Avance50",
      "nombre": "Avance al 50%",
      "descripcion": "Progreso considerable."
    },
    {
      "codigo": "Urbanizado",
      "nombre": "Urbanizado",
      "descripcion": "Etapa estándar."
    },
    {
      "codigo": "Entregado",
      "nombre": "Entregado",
      "descripcion": "Máxima plusvalía."
    }
  ],

  "ESPECIALES": [
    {
      "codigo": "ClubHouse",
      "nombre": "Club House",
      "descripcion": "Acceso a zona VIP o club."
    },
    {
      "codigo": "LagoCerca",
      "nombre": "Cerca a laguna",
      "descripcion": "Atractivo turístico natural."
    },
    {
      "codigo": "AccMuelle",
      "nombre": "Acceso a muelle",
      "descripcion": "Proyectos náuticos."
    },
    {
      "codigo": "ZonaEcuestre",
      "nombre": "Zona ecuestre",
      "descripcion": "Actividades de campo o caballos."
    },
    {
      "codigo": "AccCiclovia",
      "nombre": "Acceso a ciclovía",
      "descripcion": "Zona para bicicleta o deporte."
    },
    {
      "codigo": "DobleSalida",
      "nombre": "Doble salida",
      "descripcion": "Ideal para comercio o doble acceso."
    },
    {
      "codigo": "LoteComer",
      "nombre": "Lote comercial",
      "descripcion": "Zonas para negocio."
    }
  ]
}













## 2) Resumen detallado del módulo LOTES (estado actual)

### A) Qué hace el módulo LOTES

1. **Listado de lotes (ADMIN)**

   * DataTable `#tblLotes` con:

     * Proyecto, Etapa, Manzana, N° lote, área, precio base, factor total %, precio final, estado, cliente.
   * Filtros por:

     * Proyecto, Etapa, Manzana, Estado de lote.
   * Acciones:

     * **Editar lote** (modal).
     * **Eliminar lote**.
     * Ver detalle en panel inferior (click en fila).

2. **Detalle de lote (panel debajo)**

   * Form `#formLoteDetalle`:

     * Datos geométricos (área, frente, fondo, lados).
     * Precio m² del lote.
     * Precio base / factor total / precio final (read-only).
     * Estado comercial (habilitado / deshabilitado).
     * Estado del lote (disponible, reservado, separado, vendido, bloqueado).
     * Cliente asociado (`id_cliente`).
     * Info de proyecto: precio m² base y límites de factor min/máx.
   * Botón **Guardar cambios**.

3. **Factores de precio por proyecto**

   * Configuración general (modal “Configurar factores de precio”):

     * Tabla de factores del proyecto (categoría, nombre, %, activo).
     * CRUD de factores (nuevo, editar, borrar).
   * Tab “Factores de precio” de cada lote:

     * Muestra los factores del proyecto.
     * Check para aplicar o no al lote.
     * Botón “Guardar factores del lote” → recalcula factor_total y precio_final.

4. **Geometría (vértices)**

   * Tab de vértices:

     * Lista de vértices (orden, lat, lng).
     * Botones:

       * Editar vértices (modal con tabla editable).
       * Eliminar vértices.
   * Modal te deja:

     * Agregar filas (vértices).
     * Eliminar filas.
     * Guardar vértices del lote.

5. **Historial de cambios**

   * Tab historial:

     * Muestra movimientos del lote:

       * fecha/hora, usuario, estado anterior/nuevo, cliente anterior/nuevo, motivo.
     * Botón de refrescar.
   * Se alimenta cuando:

     * Cambias estado.
     * Cambias cliente.
     * (Lo que tengas implementado en backend).

6. **Cambio de estado del lote**

   * Modal `modalCambiarEstadoLote`:

     * Muestra estado actual.
     * Permite seleccionar estado nuevo.
     * Asignar cliente (combo).
     * Motivo del cambio.
   * Llama a `lotes&a=cambiar_estado` y registra en historial.

7. **Vista USUARIO (vendedores)**

   * DataTable `#tblLotesUsr`:

     * Similar al admin pero:

       * Precio final solo lectura.
       * Sin botones de editar/eliminar.
     * Acciones:

       * Botón “Ver / Estado”.
   * Panel detalle usuario:

     * Todo **readonly** excepto flujo de estado restringido.
   * Cambio de estado:

     * Flujo controlado:

       * DISPONIBLE → RESERVADO
       * RESERVADO → SEPARADO
       * SEPARADO → VENDIDO
     * Mismo modal de cambio de estado, pero con opciones recortadas.

8. **Creación masiva de lotes**

   * Botón “Generar lotes manzana” (el “botón mágico”):

     * Rango de números (desde / hasta).
     * Manzana seleccionada.
     * Opcionalmente área y precio_m2 por defecto.
   * Backend valida:

     * No duplica lotes que ya existen.
     * Inserta solo los que faltan.
   * Devuelve cuántos creó y cuántos se saltaron.

---

## 3) Mejora de arquitectura: dividir JS y organizar mejor el backend

### 3.1. División del JS en 3 archivos

Ahora tienes un solo `lotes.js` gigante. Propuesta:

#### a) `public/assets/js/lotes_global.js`

**Responsabilidad:** funciones compartidas.

Contenido:

* Helpers generales:

  * `ajaxJSON(method, url, data, onOk, onErr)`
  * `badgeEstadoLote(estado)`
* Cargas de combos:

  * `loadProyectos($select, selected)`
  * `loadEtapasByProyecto(idProyecto, $select, selected, includeTodos)`
  * `loadManzanas(idProyecto, idEtapa, $select, selected, includeTodos)`
  * `loadClientes($select, selected)`
* Quizá algunos helpers de formato:

  * `formatMoney`, `formatPercent`, etc. (si los necesitas).
* Opcional:

  * Funciones para historial (`loadHistorialLoteBase(idLote, $tbody, maxRows)`), reutilizables tanto en admin como usuario.

**Inicialización:**

En vez de auto-ejecutarse, este archivo **no** inicializa nada.
Solo define un namespace, por ejemplo:

```js
window.LotesApp = window.LotesApp || {};

LotesApp.ajaxJSON = function (...) { ... };
LotesApp.loadProyectos = function (...) { ... };
// etc.
```

Así lo reutilizas desde admin y usuario sin duplicar ni la lógica ni el flag de “ya inicializado”.

---

#### b) `public/assets/js/lotes_admin.js`

**Responsabilidad:** todo lo propio del admin.

Contenido:

* Inicialización solo si existe `#tblLotes`:

```js
$(function () {
  if (!$('#tblLotes').length) return;
  console.log('Inicializando módulo Lotes ADMIN');
  LotesApp.initAdmin();
});
```

* Dentro de `LotesApp.initAdmin()`:

  1. Config de DataTable `#tblLotes` (list_admin).
  2. Filtros de proyecto/etapa/manzana/estado.
  3. Panel detalle:

     * `showDetalleLote(...)`
     * `fillProyectoCfgFromRow(...)`
     * Botón Guardar cambios.
  4. Modal de CRUD lote (nuevo / editar / borrar).
  5. Tab de factores:

     * `loadFactoresLote()`
     * Guardar factores lote.
     * Refrescar.
  6. Modal de factores de proyecto:

     * `loadFactoresProyectoTabla(id_proyecto)`
     * Nuevo/editar/eliminar factor.
  7. Vértices:

     * `loadVerticesLote()`
     * Modal de edición.
     * Guardar / eliminar vértices.
  8. Historial:

     * `loadHistorialLote()`.
  9. Cambio de estado:

     * Admin puede elegir cualquier estado.
  10. **Creación masiva de lotes**:

      * Listener de botón “Generar lotes manzana”.
      * Llamada a `lotes&a=crear_masivos`.

---

#### c) `public/assets/js/lotes_usuarios.js`

**Responsabilidad:** vista limitada para vendedores.

Contenido:

* Inicialización solo si existe `#tblLotesUsr`:

```js
$(function () {
  if (!$('#tblLotesUsr').length) return;
  console.log('Inicializando módulo Lotes USUARIO');
  LotesApp.initUsuario();
});
```

* Dentro de `LotesApp.initUsuario()`:

  1. DataTable `#tblLotesUsr` (list_usuario).
  2. Filtros de proyecto/etapa/manzana/estado.
  3. Panel detalle usuario (solo lectura).
  4. Historial resumido (últimos N movimientos).
  5. Cambio de estado con **flujo restringido**:

     * Función `buildOpcionesEstadoUsuario(estadoActual)`.
     * Uso del mismo modal `modalCambiarEstadoLote`, pero:

       * Opciones de estado controladas.
       * Mensaje de ayuda adaptado.

---

### 3.2. Cómo cargarlos en las vistas

En `index_admin.php`:

```php
<script src="public/assets/js/lotes_global.js"></script>
<script src="public/assets/js/lotes_admin.js"></script>
```

En `index_usuario.php`:

```php
<script src="public/assets/js/lotes_global.js"></script>
<script src="public/assets/js/lotes_usuarios.js"></script>
```

> Importante: `lotes_global.js` siempre va primero.

---

## 4) Posible división en Controladores y Modelos

### 4.1. Controladores

Ahora parece que tienes un solo `LotesController` con todo (admin + usuario + factores + vértices + historial + masivos).

Dos opciones:

#### Opción A (mínimo cambio, más orden):

Seguir con **un solo** `LotesController`, pero organizarlo así:

```php
class LotesController extends Controller
{
    // =======================
    // VISTAS
    // =======================
    public function index_admin() { ... }
    public function index_usuario() { ... }

    // =======================
    // LISTADOS
    // =======================
    public function list_admin() { ... }
    public function list_usuario() { ... }
    public function get() { ... }

    // =======================
    // CRUD BÁSICO
    // =======================
    public function save() { ... }
    public function delete() { ... }

    // =======================
    // FACTORES
    // =======================
    public function factores_list() { ... }
    public function factores_save() { ... }
    public function factores_delete() { ... }
    public function lote_factores_get() { ... }
    public function lote_factores_save() { ... }

    // =======================
    // VÉRTICES
    // =======================
    public function vertices_list() { ... }
    public function vertices_save() { ... }
    public function vertices_delete() { ... }

    // =======================
    // HISTORIAL
    // =======================
    public function historial_list() { ... }

    // =======================
    // ESTADO / MASIVOS
    // =======================
    public function cambiar_estado() { ... }
    public function crear_masivos() { ... }
}
```

Solo reordenar y comentar bien. Menos dolor con el enrutador actual.

---

#### Opción B (más limpio a futuro):

Crear dos controladores:

* `LotesAdminController`:

  * `index`, `list`, `save`, `delete`, `factores_*`, `vertices_*`, `historial_list`, `cambiar_estado`, `crear_masivos`.
  * Protegido para `role = admin`.

* `LotesUsuarioController`:

  * `index`, `list`, `historial_list` (o reusa del admin), `cambiar_estado` pero con validación extra de flujo.
  * Protegido para `role = vendedor` / `user`.

El enrutador cambiaría a algo tipo:

* `index.php?c=lotesAdmin&a=index`
* `index.php?c=lotesUsuario&a=index`

Si quieres esto, habría que ajustar las URLs del JS, pero es simple buscar/reemplazar.

---

### 4.2. Modelos

También aquí puedes aligerar:

#### Opción simple (suficiente por ahora):

Un solo `LotesModel` con secciones claras:

```php
class LotesModel
{
    // =======================
    // LOTES
    // =======================
    public function listAdmin(...) { ... }
    public function listUsuario(...) { ... }
    public function getById(...) { ... }
    public function saveLote(...) { ... }
    public function deleteLote(...) { ... }

    // =======================
    // FACTORES
    // =======================
    public function getFactoresProyecto(...) { ... }
    public function saveFactorProyecto(...) { ... }
    public function deleteFactorProyecto(...) { ... }
    public function getFactoresLote(...) { ... }
    public function saveFactoresLote(...) { ... }

    // =======================
    // VÉRTICES
    // =======================
    public function getVerticesLote(...) { ... }
    public function saveVerticesLote(...) { ... }
    public function deleteVerticesLote(...) { ... }

    // =======================
    // HISTORIAL
    // =======================
    public function getHistorialLote(...) { ... }
    public function addHistorialLote(...) { ... }

    // =======================
    // MASIVOS
    // =======================
    public function crearLotesMasivos(...) { ... }
}
```

#### Opción más pro:

Separar en 2 modelos:

* `LotesModel` → todo lo de `lotes`, `vertices`, `historial`, `masivos`.
* `FactoresPrecioModel` → todo lo de `factores_proyecto` y la relación `lotes_factores`.

Eso ya es más “enterprise”, pero te ayuda a que cada archivo no sea monstruoso.

---

Si quieres, en el siguiente mensaje te armo el **esqueleto concreto** de:

* `lotes_global.js`
* `lotes_admin.js`
* `lotes_usuarios.js`

con el código que ya tienes, pero reorganizado y listo para pegar.
